<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Deploy Cloud Foundry and Diego to AWS | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blurblah.github.io/2017/08/06/wp/deploy-cloud-foundry-and-diego-to-aws"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Deploy Cloud Foundry and Diego to AWS | My Site"><meta data-rh="true" name="description" content="다 정리하고보니 CF 배포는 각 component 들의 기능이나 정의, component 사이의 관계와 manifest의 설정내용을 세세하게 알아야만 하는 것이 아닌가라는 생각이 든다."><meta data-rh="true" property="og:description" content="다 정리하고보니 CF 배포는 각 component 들의 기능이나 정의, component 사이의 관계와 manifest의 설정내용을 세세하게 알아야만 하는 것이 아닌가라는 생각이 든다."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2017-08-06T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="aws,cf,cf-deploy,cf-배포,cloud-foundry,diego,클라우드-파운드리"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blurblah.github.io/2017/08/06/wp/deploy-cloud-foundry-and-diego-to-aws"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2017/08/06/wp/deploy-cloud-foundry-and-diego-to-aws" hreflang="en"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2017/08/06/wp/deploy-cloud-foundry-and-diego-to-aws" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.87564fa0.css">
<script src="/assets/js/runtime~main.e36f3c5d.js" defer="defer"></script>
<script src="/assets/js/main.dfb2dcc2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/blurblah" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2020/01/20/wp/kubernetes에서-특정-node에-pod가-배포되는-현상에-대한-분석">Kubernetes에서 특정 node에 pod가 배포되는 현상에 대한 분석</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/08/14/wp/kubernetes-with-aws-api-gateway">Kubernetes with AWS API gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/06/09/wp/날씨-정보를-편하게-받아볼까-해서-시작한-일들">날씨 정보를 편하게 받아볼까 해서 시작한 일들</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/27/wp/xiaomi-센서로-실내-온도를-측정해서-influxdb에-저장하고-grafana로-그">Xiaomi 센서로 실내 온도를 측정해서 InfluxDB에 저장하고 Grafana로 그린다</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/17/wp/snmp를-통한-asus-공유기-모니터링-시작하기">SNMP를 통한 ASUS 공유기  모니터링 시작하기</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="다 정리하고보니 CF 배포는 각 component 들의 기능이나 정의, component 사이의 관계와 manifest의 설정내용을 세세하게 알아야만 하는 것이 아닌가라는 생각이 든다."><header><h1 class="title_f1Hy" itemprop="headline">Deploy Cloud Foundry and Diego to AWS</h1><div class="container_mt6G margin-vert--md"><time datetime="2017-08-06T00:00:00.000Z" itemprop="datePublished">August 6, 2017</time> · <!-- -->28 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>다 정리하고보니 CF 배포는 각 component 들의 기능이나 정의, component 사이의 관계와 manifest의 설정내용을 세세하게 알아야만 하는 것이 아닌가라는 생각이 든다.</p>
<hr>
<p>Cloud foundry (CF)를 배포해보면서 오픈소스는 무료가 아니라는 것을 다시 느낀다. 배포 과정도 쉽지 않은데 운영시 발생할 문제들까지 고려하면 오랫동안 공을 들여야만 할 것 같다. 오픈소스 cf를 배포하면서 여러번의 삽질을 하게 된 이유가 무엇일까를 생각해보니 대략 이렇다.</p>
<p><strong>(1) 사용되는 BOSH cli version의 혼재</strong></p>
<p>BOSH cli는 현재 major version이 v2인데 공식문서의 특정 링크와 저장소별 README에 v1 기준으로 설명되어 있는 경우가 많다. v1, v2의 명령어가 다르기 때문에 문서에 기술된 내용을 수행하기 위해 명령어를 비교해보고 적합한 명령으로 변경해야 했고, 어떤 버전의 cli를 쓰는게 나을지 고민해보기도... (결국은 v2로)</p>
<p><strong>(2) 공식문서와 다르게 누락된 부분들</strong></p>
<p>아래의 링크가 AWS에 cf를 배포하기 위한 공식문서.  Manifest 파일을 generation 하기 위해 만들어야 하는 stub 파일 설정내용에는 포함되어 있지만 복사해서 쓰라고 명시된 stub 파일(skeleton)에는 빠져있어서 그냥 진행한 적이 있었다. 결국 오류가 생겨서 다시 처음부터 진행했었고 일부 설정에 대한 설명이 부족해서 어떤 값을 넣어야 하는건지 한참을 헤매야만 했다.</p>
<p><a href="http://docs.cloudfoundry.org/deploying/aws/index.html" target="_blank" rel="noopener noreferrer">http://docs.cloudfoundry.org/deploying/aws/index.html</a></p>
<p>결정적으로 공식문서에는 diego 배포에 대한 내용이 없어서 그대로 배포해봐야 application을 올리지 못하기 때문에 결국 다른 문서를 참조할 수 밖에 없었다. (<a href="https://github.com/cloudfoundry/diego-release/issues/203" target="_blank" rel="noopener noreferrer">github issue</a>를 참고하니 cf는 그대로 배포하고 diego를 default backend로 지정해서 배포하라는데 나중에 기회가 되면 시도.)</p>
<p><strong>(3) 저장소 문제</strong></p>
<p>대부분의 cf 배포문서에는 저장소(예를 들어, cf-release)를 clone 해서 sub module을 다 땡기고 BOSH cli의 create-release 명령으로 빌드를 한 후에 BOSH director에 업로드하라고 되어있지만 create-release 시점에 오류가 발생한 적이 있었다. 로그 확인해가면서 원인을 찾아보니 링크가 깨진 특정파일이 그대로 저장소에 올라가 있었기 때문인데 결국 local에서 release를 만들지 않고 이미 만들어진 release를 사용하는 방법으로 해결.</p>
<p>CF를 배포하기 위해서는 BOSH를 이용해야 하는데 BOSH director는 구성방법이 두가지인 것으로 보인다. 하나는 bosh cli (create-env)를 이용하는 것이고 두번째는 BOSH bootloader(bbl). 공식문서 대신 찾아보게 된 아래의 링크는 스크립트를 실행해서 BOSH director를 배포하도록 되어있다. AWS cloudformation에 stack을 만들어서 관리  할 수 있도록 해둔 것 같은데 director 배포는 bosh cli를 사용하고 있다.</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws</a></p>
<p>위 문서의 내용도 잘못된 내용들이 있지만 배포의 과정을 단순화하면 아래처럼 될 것 같다.</p>
<p>BOSH 배포 =&gt; CF stub 만들기 =&gt; Stub으로 manifest 생성 =&gt; CF 배포 =&gt; Diego가 사용할 DB 배포 (stub, manifest 만들어서) =&gt; Diego 배포 (역시 stub, manifest 만들어서)</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-배포-준비">1. 배포 준비<a href="#1-배포-준비" class="hash-link" aria-label="Direct link to 1. 배포 준비" title="Direct link to 1. 배포 준비">​</a></h3>
<p>BOSH cli 등을 설치하고 배포와 관련된 작업을 수행할 장비를 준비하고 진행했다. 처음엔 Ubuntu 16.04로 시작을 했는데 아래 그림처럼 stemcell upload 하는 부분에서 오류가 나서 원인을 찾다가 결국 14.04에서 다시 진행. (이 오류는 <a href="https://github.com/cloudfoundry-incubator/bosh-aws-cpi-release/issues/58" target="_blank" rel="noopener noreferrer">github issue</a>로 등록되어있음)</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-01-set_api-error.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-01-set_api-error-b04284f4ae0da9c0d9d44f019ffd6354.png" width="585" height="439" class="img_ev3q"></a></p>
<p>필요로하는 instance의 갯수가 많으므로 (40개 이상) 배포하고자 하는 region의 ec2 instance limit을 사전에 올려두는 것도 필요하다.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-install-dependencies">2. Install dependencies<a href="#2-install-dependencies" class="hash-link" aria-label="Direct link to 2. Install dependencies" title="Direct link to 2. Install dependencies">​</a></h3>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws" target="_blank" rel="noopener noreferrer">참조한 문서</a>에 명시된대로 CF를 배포하기 위해 go, godep, boosh, jq, spiff, awscli, bosh cli (v2) 가 필요하므로 설치해야 하는데 대부분은 apt-get이나 download 중 편한 방법으로 하면 되지만 jq의 경우 ubuntu 14.04에서는 꼭 download 해서 1.5 버전을 설치해야만 한다. jq 설치에 apt-get을 이용하게 되면 ubuntu 14.04에서는 1.3 버전이 설치되는데 나중에 특정 script 실행시 1.3에서 지원하지 않는 argument를 넘기게 되서 오류가 발생하게 된다. 문서에는 ruby도 설치하라고 되어있지만 bosh cli v2의 dependencies에 명시되어 있으므로 bosh cli 설치하고 진행하면 되겠다.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-clone-repositories">3. Clone repositories<a href="#3-clone-repositories" class="hash-link" aria-label="Direct link to 3. Clone repositories" title="Direct link to 3. Clone repositories">​</a></h3>
<p>저장소는 모두 4개가 필요하지만 먼저 필요한 3개의 저장소만 clone 했다. (문서대로) 그리고 저장소 및 기타 파일들을 모아둘 directory (나의 경우엔 bosh-diego라는 이름으로)를 생성하고 그 위에서 작업</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir bosh-diego</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd bosh-diego</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cloudfoundry/bosh-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cloudfoundry/cf-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cloudfoundry/diego-release</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-domain-발급-및-route53-설정">4. Domain 발급 및 Route53 설정<a href="#4-domain-발급-및-route53-설정" class="hash-link" aria-label="Direct link to 4. Domain 발급 및 Route53 설정" title="Direct link to 4. Domain 발급 및 Route53 설정">​</a></h3>
<p>개발용으로 cf를 구축하는 문서에는 domain 없이 xip.io와 elastic ip만 가지고 작업하는 내용이 있었지만 여러가지 이유로 domain을 사서 route53에 zone을 생성했다. (AWS에서 .com 도메인 사니 편하다. 12불/년)</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-env-파일-생성">5. env 파일 생성<a href="#5-env-파일-생성" class="hash-link" aria-label="Direct link to 5. env 파일 생성" title="Direct link to 5. env 파일 생성">​</a></h3>
<p>실행할 script 들 호출시 편의를 위해 env 파일을 생성하고 source로 load 한다. (아래의 내용은 상황에 맞게 수정 할 필요가 있음)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;&quot;EOF&quot; &gt; deployment-env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export DEPLOYMENT_DIR=&quot;$(cd $(dirname &quot;$BASH_SOURCE[0]&quot;) &amp;&amp; pwd)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export BOSH_DEPLOYMENT_DIR=&quot;$HOME/bosh-diego/bosh-deployment&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CF_RELEASE_DIR=&quot;$HOME/bosh-diego/cf-release&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export DIEGO_RELEASE_DIR=&quot;$HOME/bosh-diego/diego-release&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CF_DOMAIN=&quot;codealley-cf.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export STACK_NAME=&quot;codealley-cf-stack&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export gobosh=bosh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;DEPLOYMENT_DIR set to &#x27;$DEPLOYMENT_DIR&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;BOSH_DEPLOYMENT_DIR set to &#x27;$BOSH_DEPLOYMENT_DIR&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;CF_RELEASE_DIR set to &#x27;$CF_RELEASE_DIR&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;DIEGO_RELEASE_DIR set to &#x27;$DIEGO_RELEASE_DIR&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;CF_DOMAIN set to &#x27;$CF_DOMAIN&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;v2 BOSH CLI located at &#x27;$(which &quot;${gobosh}&quot;)&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source deployment-env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-iam-user-keypair-생성">6. IAM user, keypair 생성<a href="#6-iam-user-keypair-생성" class="hash-link" aria-label="Direct link to 6. IAM user, keypair 생성" title="Direct link to 6. IAM user, keypair 생성">​</a></h3>
<p><strong>(1) IAM policy 생성</strong></p>
<p>Cloudformation을 포함해 aws에 대한 모든 작업을 위한 IAM user를 생성해야 하는데 그 user에게 지정할 policy를 만들어야 한다. 아래 링크대로 진행하면 된다.</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#iam-user-policy" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#iam-user-policy</a></p>
<p>Policy 내용을 봐도 알겠지만 거의 모든 권한이 필요한데 그 중 S3는 cf가 droplet, buildpack 등을 저장하는 blobstore 대신 사용되는 것으로 보인다. (개발용으로 구축했을 때에는 cf 내부에 blobstore를 두도록 되어있었음)</p>
<p><strong>(2) IAM user 생성</strong></p>
<p>역시 아래 문서대로 user를 생성하면 된다. Access type에 대한 명시는 되어있지 않은데 aws에서 programmatic access로 선택하면 되겠다. User 생성시 다운로드 할 수 있는 credentials.csv 파일은 나중에 필요하므로 미리 다운로드 해둔다.</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#iam-user" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#iam-user</a></p>
<p><strong>(3) Keypair 생성</strong></p>
<p>배포할 region에서 keypair를 만들고나서 다운로드한 private key를 작업경로 아래의 keypair directory에 id_rsa_bosh란 이름으로 복사한 후 권한을 조정한다. 아래 링크 참조</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#aws-keypair-for-the-bosh-director" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#aws-keypair-for-the-bosh-director</a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-deployment-directory-setup">7. Deployment directory setup<a href="#7-deployment-directory-setup" class="hash-link" aria-label="Direct link to 7. Deployment directory setup" title="Direct link to 7. Deployment directory setup">​</a></h3>
<p>정해진 구조의 directory를 몇 개 생성한 후에 key, cert, stub 등의 파일을 생성해야 하는데 아래와 같다.</p>
<p><strong>(1) Directory 생성</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DEPLOYMENT_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ops-files/bosh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p stubs/bosh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir stubs/infrastructure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(2) boostrap env 생성</strong></p>
<p>Region을 지정하고 IAM user 생성시에 받아두었던 credentials.csv 파일 내부에 있는 access key id와 secret access key 값을 이용해서 파일을 만든다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/bootstrap_environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_DEFAULT_REGION=us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_ACCESS_KEY_ID=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_SECRET_ACCESS_KEY=&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(3) ELB용 key, cert 생성</strong></p>
<p>미리 보유한 인증서가 있다면 그것을 이용하면 되지만 없다면 아래처럼 self signed 인증서를 만든다. csr 파일 생성시 common name은 가지고 있는 domain의 와일드카드로 지정해야 한다. (나의 경우엔 *.codealley-cf.com)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DEPLOYMENT_DIR/certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -out elb-cfrouter.key 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -key elb-cfrouter.key -out elb-cfrouter.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -req -in elb-cfrouter.csr -signkey elb-cfrouter.key -out elb-cfrouter.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(4) Domain stub 생성</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DEPLOYMENT_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/stubs/domain.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">domain: $CF_DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(5) Instance type stub 생성</strong></p>
<p>문서상에는 지정하지 않으면 default 값으로 설정된다라고 되어있지만 파일 혹은 일부 내용은 꼭 필요한 것 같다. (파일이 아예 없는 경우 오류가 발생했었음) 어느 정도의 크기가 되어야하는지 알 수 없어서 그냥 만만한 m3.medium으로 지정해봤다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/stubs/aws-instance-types.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instance_types:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database: m3.medium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mysql_database: m3.medium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mysql_proxy: m3.medium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mysql_persistent_disk_type: gp2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(6) AZ stub 생성</strong></p>
<p>아래처럼 파일에 지정한 availability zone에 vm 생성을 하면서 이중화 구성을 하는 것으로 보인다. 일부 availability zone에서 특정 type의 instance가 생성되지 못하는 경우가 있었기 때문에 (나의 경우엔 us-east-1b에서 m3.medium 생성 불가. 메세지 상으로는 aws에 어떤 limit이 걸려있었던 것으로 보임) 필요한경우 조정을 해야한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/stubs/infrastructure/availability_zones.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  availability_zones:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - us-east-1a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - us-east-1c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - us-east-1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(7) BOSH vars 생성</strong></p>
<p>default_key_name은 AWS에서 생성한 keypair의 이름을 지정하고 director_name은 입맛대로 설정한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/stubs/bosh/vars.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_key_name: bosh-diego-keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">director_name: codealley-bosh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(8) BOSH domain stub 생성 (Optional)</strong></p>
<p>Domain도 샀겠다 편의를 위해서 bosh용 sub domain을 지정했다. 아직 bosh (bosh director)생성 전이지만 필요하다면 이렇게만 지정하고 나중에 director 생성 후에 실제 domain record를 추가하면 된다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; $DEPLOYMENT_DIR/stubs/bosh/domain.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">director_domain: bosh.codealley-cf.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(9) 기타</strong></p>
<p>문서상에 기술된 내용 중 나머지는 optional이라 설정하지 않았음</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-configuring-security">8. Configuring security<a href="#8-configuring-security" class="hash-link" aria-label="Direct link to 8. Configuring security" title="Direct link to 8. Configuring security">​</a></h3>
<p>이 부분은 cf를 구성하는 각 component 들끼리 ssl로 통신하기 위한 인증서와 key를 생성하는 내용으로 대부분 저장소에 준비되어 있는 script를 실행하는 것으로 완료할 수 있다.</p>
<p><strong>(1) Consul과 cloud controller(cc)용 certs 생성</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DEPLOYMENT_DIR/certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$CF_RELEASE_DIR/scripts/generate-cf-diego-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$CF_RELEASE_DIR/scripts/generate-consul-certs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(2) UAA용 certs생성</strong></p>
<p>UAA는 cf에서 user 인증을 담당하는 component</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pushd $CF_RELEASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/generate-uaa-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv uaa-certs/ $DEPLOYMENT_DIR/certs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd $DIEGO_RELEASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/generate-uaa-saml-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv diego-certs/uaa-saml-certs/saml.* $DEPLOYMENT_DIR/certs/uaa-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(3) Loggregator certs 생성</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$CF_RELEASE_DIR/scripts/generate-loggregator-certs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/certs/cf-diego-certs/cf-diego-ca.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/certs/cf-diego-certs/cf-diego-ca.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd $CF_RELEASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$CF_RELEASE_DIR/scripts/generate-statsd-injector-certs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/certs/loggregator-certs/loggregator-ca.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/certs/loggregator-certs/loggregator-ca.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv $CF_RELEASE_DIR/statsd-injector-certs $DEPLOYMENT_DIR/certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(4) Diego에 사용될 certs 생성</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$DIEGO_RELEASE_DIR/scripts/generate-diego-certs $DEPLOYMENT_DIR/certs/cf-diego-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv $DIEGO_RELEASE_DIR/diego-certs/* $DEPLOYMENT_DIR/certs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(5) SSH 접근을 위한 host key 생성</strong></p>
<p>Passphrase를 물어보면 공백으로 넣어야 한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -f $DEPLOYMENT_DIR/keypair/ssh-proxy-host-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -lf $DEPLOYMENT_DIR/keypair/ssh-proxy-host-key.pem.pub | cut -d &#x27; &#x27; -f2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; $DEPLOYMENT_DIR/keypair/ssh-proxy-host-key-fingerprint</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(6) UAA용 keypair 생성</strong></p>
<p>역시 이것도 passphrase는 공백</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen -t rsa -b 4096 -f $DEPLOYMENT_DIR/keypair/uaa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl rsa -in $DEPLOYMENT_DIR/keypair/uaa -pubout &gt; $DEPLOYMENT_DIR/keypair/uaa.pub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="9-cloudformation-stack-생성">9. Cloudformation stack 생성<a href="#9-cloudformation-stack-생성" class="hash-link" aria-label="Direct link to 9. Cloudformation stack 생성" title="Direct link to 9. Cloudformation stack 생성">​</a></h3>
<p>이 과정은 aws에서 cloudformation stack을 생성하고 stack에 포함될 vpc, s3 bucket 등이 자동 생성되며 BOSH director와 NAT용 vm이 만들어지는 과정이다. 단순히 script만 호출해주면 된다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DIEGO_RELEASE_DIR/examples/aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./deploy_aws_environment create-stack deploy-bosh &quot;$BOSH_DEPLOYMENT_DIR&quot; &quot;$DEPLOYMENT_DIR&quot; &quot;$STACK_NAME&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="10-login-to-bosh">10. Login to BOSH<a href="#10-login-to-bosh" class="hash-link" aria-label="Direct link to 10. Login to BOSH" title="Direct link to 10. Login to BOSH">​</a></h3>
<p>9번 과정에서 bosh director가 배포되었기 때문에 bosh director의 IP (elastic ip가 할당됨)를 확인해 route53에 record를 추가한다. (만약 위에서 bosh director에 대한 domain 설정을 하지 않았다면 아래 command에서 domain 대신 ip를 이용) 이후 cf 등을 bosh로 배포하기 위해 로그인을 해야한다. BOSH cli v1에서는 target 지정하는 내용이었는데 v2에서는 alias로 지정하는 명칭을 이후에 계속 bosh cli 실행시마다 함께 넣어줘야 해당 director에 명령을 내릴 수 있도록 되어있다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh alias-env ca-bosh -e bosh.codealley-cf.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ca-cert &lt;(bosh int $DEPLOYMENT_DIR/deployments/bosh/creds.yml --path /director_ssl/ca)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh log-in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Login시 사용되는 계정은 우선 admin으로 password는 $DEPLOYMENT_DIR/deployments/bosh/creds.yml 파일을 열어보면 자동 생성된 값을 확인할 수 있다. 추가로 원래 이전 과정 중 director의 uuid를 확인해서 자동으로 director-uuid.yml 파일에 uuid 값을 넣도록 되어있는 것 같은데 제대로 동작하지 않았다면 아래 명령으로 uuid를 확인해 값을 채워준다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Check director uuid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Insert uuid value if empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi $DEPLOYMENT_DIR/stubs/director-uuid.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-deploy-cf">11. Deploy CF<a href="#11-deploy-cf" class="hash-link" aria-label="Direct link to 11. Deploy CF" title="Direct link to 11. Deploy CF">​</a></h3>
<p><strong>(1) CF properties stub 수정</strong></p>
<p>위 과정까지 문제가 없었다면 $DEPLOYMENT_DIR/stubs/cf/properties.yml 파일이 자동생성 되어있는데 이 파일을 열어서 REPLACE_WITH_ 로 시작하는 부분을 교체해줘야 한다. 그 중 REPLACE_WITH_CF_DEPLOYMENT_NAME은 이후에 bosh command 실행시 계속 사용될 명칭이므로 적당한 값을 입력해주면 되고, cc의 db_encryption_key 항목은 32개의 random 값을 입력해주면 되므로 아래의 command를 사용한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LC_ALL=C tr -dc &#x27;A-Za-z0-9&#x27; &lt; /dev/urandom | head -c 32 ; echo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>상세 설정 내용에 대해서는 아래의 두 문서를 참조 (동일하지는 않으니 지정할 항목에 대해서만 참조하면 되겠다)</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#fill-in-properties-stub" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#fill-in-properties-stub</a></p>
<p><a href="http://docs.cloudfoundry.org/deploying/aws/cf-stub.html#editing" target="_blank" rel="noopener noreferrer">http://docs.cloudfoundry.org/deploying/aws/cf-stub.html#editing</a></p>
<p><strong>(2) CF manifest 생성</strong></p>
<p>아래의 command를 실행한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $CF_RELEASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/generate_deployment_manifest aws \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/stubs/director-uuid.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DIEGO_RELEASE_DIR/examples/aws/stubs/cf/diego.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/stubs/cf/properties.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/stubs/cf/stub.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; $DEPLOYMENT_DIR/deployments/cf.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(3) Upload stemcell</strong></p>
<p>Component 들이 올라갈 instance 들의 base image를 bosh director로 업로드하는 과정으로 local에 있는 stemcell을 올릴수도 있지만 현재는 갖고 있지 않으므로 공개되어 있는 stemcell을 이용하도록 한다. 이 때 버전을 지정할 수도 있는데 나의 경우에는 v267을 배포할 것이기 때문에 <a href="https://github.com/cloudfoundry/cf-release/releases/tag/v267" target="_blank" rel="noopener noreferrer">release note</a>를 확인해서 3421.11 버전으로 진행함</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-stemcell https://bosh.io/d/stemcells/bosh-aws-xen-hvm-ubuntu-trusty-go_agent?v=3421.11</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(4) Upload cf release</strong></p>
<p>위에서도 언급했듯이 대부분의 문서에서는 create-release를 해서 local에 생성된 release package를 upload 하라고 기술되어 있지만 오류가 발생하는 경우가 있어서 아래의 command로 v267을 upload 함</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release releases/cf/cf-267.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(5) Deploy</strong></p>
<p>Manifest가 생성되어 있고 배포에 필요한 package 들도 upload된 상태이기 때문에 deploy 명령만 bosh로 내려주면 된다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh -d codealley-cf deploy $DEPLOYMENT_DIR/deployments/cf.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>문제없이 완료된 경우 아래 command를 실행해보면 배포된 component에 대한 instance list를 확인할 수 있다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh vms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-02-cf-vms.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-02-cf-vms-1024x621-1c117ea22fdc6a3ccbef2d8059331268.png" width="1024" height="621" class="img_ev3q"></a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-deploy-cf-mysql-for-diego">12. Deploy CF MySQL for Diego<a href="#12-deploy-cf-mysql-for-diego" class="hash-link" aria-label="Direct link to 12. Deploy CF MySQL for Diego" title="Direct link to 12. Deploy CF MySQL for Diego">​</a></h3>
<p>CF를 구성하는 대부분의 component들은 배포가 된 상황인데 중요한 diego는 없다. 과거에는 대신 dea가 있었던 것으로 보이는데 지금은 instance list에서 dea를 확인할 수 없다. Diego 배포를 하기 전에 diego가 사용할 db를 준비해야 한다고 문서에 기술되어 있는데 aws rds를 이용하거나 standalone으로 구축하는 방법, 또는 cf-release에 포함되어있는 postgresql을 이용할 수 있는 것 같다. 그 중에서 rds는 비용문제로 포기하고 이미 11번 과정에서 배포된 postgresql을 이용해볼까 하다가 궁금해서 standalone으로 구성해보기로 했다.</p>
<p><strong>(1) Clone repository</strong></p>
<p>cf-mysql-deployment repo를 clone한다. (release-candidate branch)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DEPLOYMENT_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone -b release-candidate https://github.com/cloudfoundry/cf-mysql-deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(2) Deployment name 설정</strong></p>
<p>$DEPLOYMENT_DIR/stubs/cf-mysql/mysql-overrides-ops.yml 파일을 열어서 REPLACE_WITH_CF_MYSQL_DEPLOYMENT_NAME 부분을 원하는 명칭으로 지정한다.</p>
<p><strong>(3) Consul</strong> ips, <strong>encrypt keys 지정</strong></p>
<p>이미 배포되어 있는 consul의 ip들과 encryption key를 설정해야 하는데 둘 다 복수형이므로 yml 파일에 list나 배열형태로 집어넣어줘야 한다. (문서에는 encrypt_keys 라고만 명시되어 있어서 처음에는 단일 문자열 값으로 설정해서 배포했었는데 오류 발생)</p>
<p>아래의 파일을 열어서 REPLACE_WITH_CONSUL_ENCRYPT_KEYS와 REPLACE_WITH_CONSUL_SERVER_IPS를 교체한다.</p>
<p>$DEPLOYMENT_DIR/stubs/cf-mysql/mysql-overrides-ops.yml</p>
<p>이 때 consul의 ip는 bosh vms 명령으로 확인</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh vms | grep consul</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(4) DB password 설정</strong></p>
<p>아래의 파일을 열어서 diego와 locket schema의 password를 원하는 값으로 설정해준다.</p>
<p>$DEPLOYMENT_DIR/stubs/cf-mysql/mysql-overrides-ops.yml</p>
<p><strong>(5) Update cloud config / deploy</strong></p>
<p>아래 command를 실행해서 cloud config 파일을 갱신하고 deploy</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh update-cloud-config $DEPLOYMENT_DIR/stubs/cloud-config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh -d codealley-cf-mysql deploy \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/cf-mysql-deployment/cf-mysql-deployment.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --vars-file $DEPLOYMENT_DIR/stubs/cf-mysql/consul-secrets.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --vars-store $DEPLOYMENT_DIR/deployments/cf-mysql-vars.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -o $DEPLOYMENT_DIR/cf-mysql-deployment/operations/proxy-consul.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -o $DEPLOYMENT_DIR/stubs/cf-mysql/mysql-overrides-ops.yml --no-redact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>역시 특별한 문제없이 완료되었다면 위에서 지정한 deployment name을 지정해서 vms 명령을 실행해보면 아래 그림과 같은 형태의 instance list를 확인할 수 있다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-03-cf-mysql-vms.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-03-cf-mysql-vms-a67d5ab79f54e59c90e8effefeb080a1.png" width="585" height="473" class="img_ev3q"></a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-deploy-diego">13. Deploy Diego<a href="#13-deploy-diego" class="hash-link" aria-label="Direct link to 13. Deploy Diego" title="Direct link to 13. Deploy Diego">​</a></h3>
<p>마지막으로 diego를 배포해야 하는데 위의 과정들과 거의 유사하다. Stub 생성 또는 수정, 그리고 manifest 생성 후 필요한 경우 release package를 업로드하고 deploy.</p>
<p><strong>(1) Diego</strong> sql <strong>stub 생성</strong></p>
<p>아래 문서를 참조하면 각 항목을 어떤 값으로 채워야 하는지 알 수 있다.</p>
<p><a href="https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#fill-in-diego-sql-stub" target="_blank" rel="noopener noreferrer">https://github.com/cloudfoundry/diego-release/tree/develop/examples/aws#fill-in-diego-sql-stub</a></p>
<p>대충 $DEPLOYMENT_DIR/stubs/diego/diego-sql.yml 파일이 이런 모양이 된다. (SSL 설정은 안함)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sql_overrides:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_driver: mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_host: mysql.service.cf.internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_port: 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_username: diego</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_password: test1q2w3e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_schema: diego</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_open_connections: 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    require_ssl: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca_cert: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  locket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_driver: mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_host: mysql.service.cf.internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_port: 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_username: locket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_password: test1q2w3e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_schema: locket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    require_ssl: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca_cert: null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>**(2) property-overrides.**yml <strong>파일 수정</strong></p>
<p>$DEPLOYMENT_DIR/stubs/diego/property-overrides.yml 파일을 열어서 REPLACE_WITH_ 항목들을 지정해야 한다. REPLACE_WITH_ACTIVE_KEY_LABEL은 임의의 값으로 정해도 무방하고 REPLACE_WITH_A_SECURE_PASSPHRASE 역시 적합한 값으로 설정한다.</p>
<p><strong>(3) instance-count-overrides stub 생성</strong></p>
<p>Diego의 component들을 어떤 zone에 몇개 instance로 배포할 것인지를 설정하는 내용인데 문서상에는 $DIEGO_RELEASE_DIR/examples/aws/stubs/diego/instance-count-overrides-example.yml 파일을 복사해서 변경해 쓰라고 명시되어 있지만 실제 파일에는 상세 내용이 없기 때문에 테스트 용도로 만들어진 파일을 사용해봤다. 아래 command로 다운로드한 파일을 열어서 instance count를 지정하면 완료. (Component 종류별 로 z1, z2에 대해서만 하나씩 지정함. 필요없다고 생각한 일부 component를 0으로 지정하고 배포해보니 오류)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o $DEPLOYMENT_DIR/stubs/diego/instance-count-overrides.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://raw.githubusercontent.com/cloudfoundry/diego-upgrade-stability-tests/master/cell2/instance-count-overrides.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi $DEPLOYMENT_DIR/stubs/diego/instance-count-overrides.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(4) Release version stub 생성</strong></p>
<p>(3)과 동일하게 문서상에는 저장소에 있는 파일을 복사해서 쓰라고 되어있으나 내용은 비어있다. <a href="https://github.com/cloudfoundry/cf-release/releases" target="_blank" rel="noopener noreferrer">Release note</a>를 참고해서 배포하고자 하는 cf version에 필요한 release package들을 지정한다. <a href="https://github.com/cloudfoundry/cf-release/releases/tag/v267" target="_blank" rel="noopener noreferrer">v267</a>의 경우 아래와 같은 내용이면 되겠다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cp $DIEGO_RELEASE_DIR/examples/aws/stubs/diego/release-versions.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $DEPLOYMENT_DIR/stubs/diego/release-versions.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi $DEPLOYMENT_DIR/stubs/diego/release-versions.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">release-versions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  diego: 1.21.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cflinuxfs2: 1.137.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  garden-runc: 1.9.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cf-networking: 1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grootfs: 0.21.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(5) Diego manifest 생성</strong></p>
<p>ETCD를 사용하지 않을 것이기 때문에 -x 옵션을 추가해서 생성했음</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $DIEGO_RELEASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/generate-deployment-manifest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -c $DEPLOYMENT_DIR/deployments/cf.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -i $DEPLOYMENT_DIR/stubs/diego/iaas-settings.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p $DEPLOYMENT_DIR/stubs/diego/property-overrides.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -n $DEPLOYMENT_DIR/stubs/diego/instance-count-overrides.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v $DEPLOYMENT_DIR/stubs/diego/release-versions.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -s $DEPLOYMENT_DIR/stubs/diego/diego-sql.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -x \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; $DEPLOYMENT_DIR/deployments/diego.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(6) Upload release</strong></p>
<p>Diego에 필요한 release package들을 bosh로 올리는 과정인데 역시 create-release 하지 않고 공개되어 있는 버전을 이용했다. 이 때 사용할 버전들은 (4)의 release-versions.yml 파일과 동일하게 맞춰야 한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release https://bosh.io/d/github.com/cloudfoundry/diego-release?v=1.21.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release https://bosh.io/d/github.com/cloudfoundry/cflinuxfs2-release?v=1.137.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release https://bosh.io/d/github.com/cloudfoundry/garden-runc-release?v=1.9.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release https://bosh.io/d/github.com/cloudfoundry-incubator/cf-networking-release?v=1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh upload-release https://bosh.io/d/github.com/cloudfoundry/grootfs-release?v=0.21.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(7) Deploy</strong></p>
<p>아래의 command로 위에서 생성한 manifest를 지정해서 실행</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bosh -e ca-bosh -d codealley-cf-diego deploy $DEPLOYMENT_DIR/deployments/diego.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>역시 deployment name을 지정해서 instance list를 확인하면 아래의 그림처럼 표시된다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-04-diego-vms.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-04-diego-vms-1024x622-ea43d5a5b273c46440dfb9fedb9094ba.png" width="1024" height="622" class="img_ev3q"></a></p>
<p><strong>(8) 배포 확인</strong></p>
<p>아래의 command를 실행해서 정상여부를 판단할 수도 있다. (info를 확인하는 것은 diego와는 관계가 없기 때문에 cf 배포후에도 확인할 수 있는 내용)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl api.codealley-cf.com/info</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-06-check-deploy.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-06-check-deploy-c7de4e648b1e0e2485cf037672eb5980.png" width="570" height="439" class="img_ev3q"></a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-install-cf-cli">14. Install CF cli<a href="#14-install-cf-cli" class="hash-link" aria-label="Direct link to 14. Install CF cli" title="Direct link to 14. Install CF cli">​</a></h3>
<p>이제 배포된 cf에 application을 올려볼 차례인데 그 전에 cf cli를 설치해야 한다. <a href="https://docs.cloudfoundry.org/cf-cli/install-go-cli.html" target="_blank" rel="noopener noreferrer">링크 문서</a>를 참조하거나 아래의 command로 설치</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;deb http://packages.cloudfoundry.org/debian stable main&quot; | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get install cf-cli</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="15-deploy-sample-application">15. Deploy sample application<a href="#15-deploy-sample-application" class="hash-link" aria-label="Direct link to 15. Deploy sample application" title="Direct link to 15. Deploy sample application">​</a></h3>
<p>CF cli를 처음 실행하는 거라면 org, space 생성과 target space 지정 등의 과정이 필요하다.</p>
<p><strong>(1) CF login</strong></p>
<p>사용하기로 설정한 cf의 api domain에 연결을 해야하는데 self signed 인증서를 넣어두었으므로 --skip-ssl-validation 옵션을 주어야 한다. 이 때 사용되는 계정(Email)은 admin으로 password는 이전에 설정했던 값으로 입력 (나의 경우엔 test1q2w3e)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cf login -a https://api.codealley-cf.com --skip-ssl-validation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-07-cf-login.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-07-cf-login-bbd40bfe64772868cc494c4f68d968d4.png" width="563" height="322" class="img_ev3q"></a></p>
<p><strong>(2) Org, space 생성과 target 지정</strong></p>
<p>Org는 기본으로 system이 생성되어 있는데 별도로 만들어도 좋고 그냥 쓰겠다면 아래 command로 space(이 경우엔 development)만 하나 생성하고 해당 space를 target으로 지정하면 되겠다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cf create-space development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cf target -s development</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>(3) Clone sample application &amp; deploy</strong></p>
<p>CF sample 중 spring-music을 배포해보기로 했는데 많은 경우 cf push 명령만으로 배포가 가능하지만 spring-music의 경우 빌드 과정이 필요한 것 같다. Java8이 설치되어있지 않았으므로 설치하고 JAVA_HOME 지정</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Install java8 and export JAVA_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo add-apt-repository ppa:webupd8team/java -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get install -y oracle-java8-installer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;export JAVA_HOME=/usr/lib/jvm/java-8-oracle&#x27; &gt;&gt; ~/.profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Clone and build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cloudfoundry-samples/spring-music</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd spring-music</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./gradlew clean assemble</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cf push</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Push가 완료되면 아래와 같은 화면을 볼 수 있다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-08-cf-push.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-08-cf-push-2a53d9ca280c26bf8a1e8ebff1ab72b7.png" width="570" height="439" class="img_ev3q"></a></p>
<p>CF cli 명령 중 배포된 application 전체를 확인하는 cf apps를 실행해보면 아래 그림처럼 상태와 사용중인 resource 정보가 표시되고 자동으로 할당된 url도 확인 가능하다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-09-cf-apps.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-09-cf-apps-4f0ef378c08af4e843be9ddae305e264.png" width="570" height="439" class="img_ev3q"></a></p>
<p>cf apps에 표시된 url로 접속하면 아래 그림처럼 배포된 상태의 application 화면을 볼 수 있음</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-10-access-app.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-10-access-app-1024x621-4fe351054c620fb746f8b7842c4e32ce.png" width="1024" height="621" class="img_ev3q"></a></p>
<p> </p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="16-resources">16. Resources<a href="#16-resources" class="hash-link" aria-label="Direct link to 16. Resources" title="Direct link to 16. Resources">​</a></h3>
<p>CF를 배포하고 나서 aws에 생성된 resource가 얼마나 되는지 확인해 보니 아래 그림처럼 instance가 상당히 많다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2017/08/cf-11-resources.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/cf-11-resources-6cf87581029c4ab18dc741f1a219c9c4.png" width="654" height="209" class="img_ev3q"></a></p>
<p>41개 vm 중 bosh director와 NAT용 vm이 하나씩이고 cf를 구성하는 component vm이 무려 38개 (HA 구성. Diego용 db는 줄일 수 있을 것 같기도 함), application이 올라갈 수 있는 diego cell은 1개 뿐이다. Application을 많이 배포할수록 cell을 추가해야 하고 기타 LB나S3, attach된 disk 사용료, traffic 비용까지 고려하면 꽤 큰 규모의 resource 사용을 예상하고 준비해야 할 것 같다.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cf">cf</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cf-deploy">cf-deploy</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cf-배포">cf-배포</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cloud-foundry">cloud-foundry</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/diego">diego</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/클라우드-파운드리">클라우드-파운드리</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2017/08/08/wp/장애로-살펴본-aws-efs-performance-issue"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">장애로 살펴본 AWS EFS performance issue?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2017/03/06/wp/mysql-replication을-해보자-lb-이중화"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MySQL replication을 해보자 - LB 이중화</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-배포-준비" class="table-of-contents__link toc-highlight">1. 배포 준비</a></li><li><a href="#2-install-dependencies" class="table-of-contents__link toc-highlight">2. Install dependencies</a></li><li><a href="#3-clone-repositories" class="table-of-contents__link toc-highlight">3. Clone repositories</a></li><li><a href="#4-domain-발급-및-route53-설정" class="table-of-contents__link toc-highlight">4. Domain 발급 및 Route53 설정</a></li><li><a href="#5-env-파일-생성" class="table-of-contents__link toc-highlight">5. env 파일 생성</a></li><li><a href="#6-iam-user-keypair-생성" class="table-of-contents__link toc-highlight">6. IAM user, keypair 생성</a></li><li><a href="#7-deployment-directory-setup" class="table-of-contents__link toc-highlight">7. Deployment directory setup</a></li><li><a href="#8-configuring-security" class="table-of-contents__link toc-highlight">8. Configuring security</a></li><li><a href="#9-cloudformation-stack-생성" class="table-of-contents__link toc-highlight">9. Cloudformation stack 생성</a></li><li><a href="#10-login-to-bosh" class="table-of-contents__link toc-highlight">10. Login to BOSH</a></li><li><a href="#11-deploy-cf" class="table-of-contents__link toc-highlight">11. Deploy CF</a></li><li><a href="#12-deploy-cf-mysql-for-diego" class="table-of-contents__link toc-highlight">12. Deploy CF MySQL for Diego</a></li><li><a href="#13-deploy-diego" class="table-of-contents__link toc-highlight">13. Deploy Diego</a></li><li><a href="#14-install-cf-cli" class="table-of-contents__link toc-highlight">14. Install CF cli</a></li><li><a href="#15-deploy-sample-application" class="table-of-contents__link toc-highlight">15. Deploy sample application</a></li><li><a href="#16-resources" class="table-of-contents__link toc-highlight">16. Resources</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>