<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Mesos 기반에서의 Docker 부하 테스트와 모니터링 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blurblah.github.io/2016/11/18/wp/mesos-기반에서의-docker-부하-테스트와-모니터링"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Mesos 기반에서의 Docker 부하 테스트와 모니터링 | My Site"><meta data-rh="true" name="description" content="Docker container의 부하 분산과 auto scaling을 고민해야 하는 상황인데 부하 분산을 하기 위해서는 부하 테스트를 어떻게 할지부터 생각해봐야한다. 또 어느 정도의 stress에서 성능이 얼마나 떨어지는지 알아야 하기 때문에 모니터링도."><meta data-rh="true" property="og:description" content="Docker container의 부하 분산과 auto scaling을 고민해야 하는 상황인데 부하 분산을 하기 위해서는 부하 테스트를 어떻게 할지부터 생각해봐야한다. 또 어느 정도의 stress에서 성능이 얼마나 떨어지는지 알아야 하기 때문에 모니터링도."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2016-11-18T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="cadvisor,container,docker,docker-monitoring,docker-performance-test,docker-stress-test,docker-모니터링,docker-부하-테스트,marathon,mesos,mesosphere,ngrinder-사용,메소스,컨테이너"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blurblah.github.io/2016/11/18/wp/mesos-기반에서의-docker-부하-테스트와-모니터링"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2016/11/18/wp/mesos-기반에서의-docker-부하-테스트와-모니터링" hreflang="en"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2016/11/18/wp/mesos-기반에서의-docker-부하-테스트와-모니터링" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.87564fa0.css">
<script src="/assets/js/runtime~main.e36f3c5d.js" defer="defer"></script>
<script src="/assets/js/main.dfb2dcc2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/blurblah" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2020/01/20/wp/kubernetes에서-특정-node에-pod가-배포되는-현상에-대한-분석">Kubernetes에서 특정 node에 pod가 배포되는 현상에 대한 분석</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/08/14/wp/kubernetes-with-aws-api-gateway">Kubernetes with AWS API gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/06/09/wp/날씨-정보를-편하게-받아볼까-해서-시작한-일들">날씨 정보를 편하게 받아볼까 해서 시작한 일들</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/27/wp/xiaomi-센서로-실내-온도를-측정해서-influxdb에-저장하고-grafana로-그">Xiaomi 센서로 실내 온도를 측정해서 InfluxDB에 저장하고 Grafana로 그린다</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/17/wp/snmp를-통한-asus-공유기-모니터링-시작하기">SNMP를 통한 ASUS 공유기  모니터링 시작하기</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Docker container의 부하 분산과 auto scaling을 고민해야 하는 상황인데 부하 분산을 하기 위해서는 부하 테스트를 어떻게 할지부터 생각해봐야한다. 또 어느 정도의 stress에서 성능이 얼마나 떨어지는지 알아야 하기 때문에 모니터링도."><header><h1 class="title_f1Hy" itemprop="headline">Mesos 기반에서의 Docker 부하 테스트와 모니터링</h1><div class="container_mt6G margin-vert--md"><time datetime="2016-11-18T00:00:00.000Z" itemprop="datePublished">November 18, 2016</time> · <!-- -->16 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Docker container의 부하 분산과 auto scaling을 고민해야 하는 상황인데 부하 분산을 하기 위해서는 부하 테스트를 어떻게 할지부터 생각해봐야한다. 또 어느 정도의 stress에서 성능이 얼마나 떨어지는지 알아야 하기 때문에 모니터링도.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-environments">1. Environments<a href="#1-environments" class="hash-link" aria-label="Direct link to 1. Environments" title="Direct link to 1. Environments">​</a></h3>
<p>며칠 고민하고 검토해서 현재는 아래와 같은 상태로 만들어둔 상태인데 서비스 오케스트레이션을 위해 Apache Mesos와 Marathon framework을 사용하다보니 편한 것도 있는데 고민해야할 요소들도 많아진 것 같다. 단지 부하를 가하고 모니터링이 되는지 정도만 확인할거라 테스트 대상이 되는 web container는 python으로 hello world만 뿌려주는 간단한 <a href="https://hub.docker.com/r/training/webapp/" target="_blank" rel="noopener noreferrer">웹앱</a>을 사용했고 container 자체에는 cpu 0.5 core, memory 256MB만 할당. Load balancer는 marathon에서 제공하는 marathon-lb인데 0.5 core / 128MB만 할당해 두었다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/container-load-environment.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="container-load-environment" src="/assets/images/container-load-environment-15c1a045ebce093d1ef5db8a3f8007a0.png" width="779" height="591" class="img_ev3q"></a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-stress는-ngrinder로">2. Stress는 ngrinder로<a href="#2-stress는-ngrinder로" class="hash-link" aria-label="Direct link to 2. Stress는 ngrinder로" title="Direct link to 2. Stress는 ngrinder로">​</a></h3>
<p>Stress를 어떻게 줄까 고민하다가 Apache JMeter를 처음에 고려했는데 사용에 번거로운 요소들이 조금 있고 맥에서는 UI가 별로라 ngrinder를 시도해보게 되었다. 눈에 띄는 버그가 있긴 했지만 단순히 부하만 가하고 싶을 때 간편하게 할 수 있고 확장이 쉬워보이는게 장점인 것 같다.</p>
<p><strong>(1) Agent, controller 사이의 통신 문제</strong></p>
<p>ngrinder에서는 agent 하나에서 생성하는 process의 thread 하나를 가상 유저로 취급하는 것으로 보이는데 agent가 동작하는 환경을 고려했을 때 process와 thread의 수가 높으면 controller와의 통신에 문제가 생긴다. 찾아보니 이 문제는 이미 보고된 내용인 것 같고 현재는 적당히 수치를 조절하면서 사용해야 할 것 같다. 실제로 문제가 발생하는 process, thread 수보다 적게 설정해서 테스트를 해보니 agent가 돌아가는 vm의 cpu usage가 거의 full이었는데 agent가 돌아가는 환경에 대한 문제로 인식해야 할 것 같음.</p>
<p><strong>(2) Agent 추가를 통한 stress 범위 확장과 클러스터링</strong></p>
<p>더 많은 stress를 가하고 싶다면 agent를 확장하는 방법도 있  는데, 비현실적이지만 단순히 부하만 가하기 위해서 처음에 vm 10대에서 agent를 돌리다가 현재는 5대로 줄여놓은 상태. 나중에 script를 추가하거나 변경하게 되었을 때 필요하면 다시 늘리면 된다. 아직 해보지는 않았지만 문서 상으로는 ngrinder controller의 경우 clustering이 가능한 것 같다.</p>
<p><strong>(3) Test script로 다양한 시뮬레이션 가능</strong></p>
<p>비현실적인 가상의 stress를 테스트하는 거지만 script 추가, 수정으로 조금 더 현실적인 테스트가 가능하게 되어있다. 예를 들어 가상 유저의 think time을 고려하고 싶다면 script에 sleep을 넣는 식으로 구현이 가능.</p>
<p><strong>(4) Monitor의 한계</strong></p>
<p>Target이 되는 시스템 모니터 용으로 사용할 수 있는 모듈이 controller에 들어있어서 다운로드 후에 target에 넣고 돌릴 수 있게 되어있는데 target의 ip와 port를 설정파일에 넣고 바인딩하도록 되어있다. 이 방식은 container에서 사용하기 어렵거나 가능하더라도 번거로워질 것 같다. Marathon framework에서는 container 별로 가상 ip를 부여하는 방식을 지원하려고 하는 것 같은데 아직 완전하지 않고 ip를 굳이 할당하고 싶다면 별도로 vip를 부여할 수 있도록 구성해줘야 한다.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-모니터링을-위해-cadvisor를-사용해보자">3. 모니터링을 위해 cAdvisor를 사용해보자<a href="#3-모니터링을-위해-cadvisor를-사용해보자" class="hash-link" aria-label="Direct link to 3. 모니터링을 위해 cAdvisor를 사용해보자" title="Direct link to 3. 모니터링을 위해 cAdvisor를 사용해보자">​</a></h3>
<p>ngrinder의 monitor도 사용하기 어렵고 일반적인 모니터링 도구인 zabbix, cacti, nagios 등도 container에는 적합하지 않다는 생각을 했는데 이유는 아래와 같다.</p>
<p><strong>(1) Target에 binding 되는 형태</strong></p>
<p>모니터링 지표들을 agent 형태의 모듈들이 직접 중앙으로 쏴주는 형태라면 괜찮을거라고 생각하는데 거꾸로 중앙에서 각 container에 접근해야 하는 형태라면 혹은 그렇지 않더라도 위에서처럼 target 각각의 ip나 hostname으로 바인딩해야 한다면 번거로워질 것 같다.</p>
<p><strong>(2) Host와 container를 함께 관리하기 어렵다</strong></p>
<p>(1)의 문제를 갖고 있지 않더라도 일반적인 tool로는 container와 host 모두를 함께 확인하기 어렵다. 각각을 다른 모니터링 대상으로 보고 따로 관리하면 가능할텐데 한 host에 어떤 container들이 올라가 있고 각각의 container가 어떤 상태인지, 부하가 가해졌을 때 host는 어떻게 되는지를 함께 확인할 수 있어야 더 유용하다고 본다.</p>
<p><strong>(3) Container 이중화의 문제</strong></p>
<p>부하를 분산하기 위해, 또는 다른 이유로 하나의 container를 이중화 하거나 여러개로 분산하는 경우 분산된 container들 각각의 상태와 또 하나의 서비스 관점에서 통합된 지표를 확인할 필요가 있을 것 같다.</p>
<p>이 내용들을 정리하자면 일반적인 모니터링 도구들은 물리적인 서버나 vm에 초점을 맞추고 있다는 생각이고 그 위에서 동작하는 container의 모니터링은 조금 다른 관점에서 접근할 필요가 있다고 본다. 그래서 docker 모니터링 도구들이 있는지 확인해보게 되었는데 아래의 글을 보고 우선은 cAdvisor를 검토해보기로 했다.</p>
<p><a href="http://rancher.com/comparing-monitoring-options-for-docker-deployments/" target="_blank" rel="noopener noreferrer">http://rancher.com/comparing-monitoring-options-for-docker-deployments/</a></p>
<p> </p>
<p>우선은 Marathon framework으로 mesos slave node 각각에 deploy를 했다. 아래의 json을 curl로 날리면 끝. 아니면 직접 marathon ui에서 생성 해도 된다. 최근의 marathon은 constraints 설정으로 각 node에 container가 하나씩만 배포할 수 있는 기능을 제공하고 있다. 또, network을 HOST 모드로 지정하면 BRIDGE 모드에서처럼 container와 host의 port를 각각 매핑하지 않아도 되고 marathon의 service port가 임의로 붙지 않아서 편하다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: &quot;cadvisor&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;cmd&quot;: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;cpus&quot;: 0.5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem&quot;: 256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;instances&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;container&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;docker&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;image&quot;: &quot;google/cadvisor&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;network&quot;: &quot;HOST&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;privileged&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;parameters&quot;: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;type&quot;: &quot;DOCKER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;volumes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;hostPath&quot;: &quot;/&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;containerPath&quot;: &quot;/rootfs&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;mode&quot;: &quot;RO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;hostPath&quot;: &quot;/var/run&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;containerPath&quot;: &quot;/var/run&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;mode&quot;: &quot;RW&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;hostPath&quot;: &quot;/sys&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;containerPath&quot;: &quot;/sys&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;mode&quot;: &quot;RO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;hostPath&quot;: &quot;/var/lib/docker&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;containerPath&quot;: &quot;/var/lib/docker&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;mode&quot;: &quot;RO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;portDefinitions&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;port&quot;: 8080,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;protocol&quot;: &quot;tcp&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;labels&quot;: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;env&quot;: {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;labels&quot;: {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;healthChecks&quot;: [],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;constraints&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;hostname&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;UNIQUE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>cAdvisor까지 배포된 후 ngrinder로 간단하게 부하를 발생시켜봤다. Script 등은 그대로 두고 agent는 하나만 사용하는 것으로 해서 테스트를 해보니 아래 그림처럼 cAdvisor의 그래프가 변화한다. 우선은 CPU만 확인해봤는데 container 내부에서는 대략 80% 이하로 cpu를 점유하는 것 같고 동작중인 host 전체에서는 50% 정도의 사용량을 찍었다. 여기서 host의 50% 점유율은 테스트 대상이 되는 container가 단독으로 만들어낸 사용량은 아니지만 (LB 등도 돌아가고 있으므로) container의 사용량이 올라갈수록 container가 동작중인 host에도 많은 부하가 걸림을 알 수 있다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-ngrinder-normal.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-ngrinder-normal" src="/assets/images/edited-ngrinder-normal-b24e26e827dff4ebdc5dcdc785234379.png" width="969" height="437" class="img_ev3q"></a></p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-cpu-normal-1.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-cpu-normal" src="/assets/images/edited-cpu-normal-1-065073919ee2311b45c408637623a70c.png" width="1176" height="197" class="img_ev3q"></a></p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-container와-host에-걸리는-부하">4. Container와 host에 걸리는 부하<a href="#4-container와-host에-걸리는-부하" class="hash-link" aria-label="Direct link to 4. Container와 host에 걸리는 부하" title="Direct link to 4. Container와 host에 걸리는 부하">​</a></h3>
<p>간단한 부하테스트와 모니터링이 가능한 것은 확인했는데 auto scaling을 구현하는게 어찌보면 최종 목표이기 때문에 단일 container가 감당하지 못할 정도의 부하를 줄 수 있는지 확인해보기로 했다. 그래서 ngrinder agent를 5개로 늘려 가상 사용자를 2500으로 만들어서 다시 테스트.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-ngrinder-high.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-ngrinder-high" src="/assets/images/edited-ngrinder-high-95fd1c15b1327cbf3c826c609732405b.png" width="966" height="433" class="img_ev3q"></a></p>
<p>위 그림처럼 테스트 도중에 TPS가 0으로 떨어지고 이미지는 첨부하지 않았지만 그 시점부터 error가 발생한다. 이 때 container와 host의 상태는 어떨까? 아래 그림처럼 container는 본인에게 할당된 core 이상을 점유하는 경우가 발생하고, host (2core 짜리 VM)도 거의 100%에 가까운 사용량을 보이다가 줄어든다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-cpu-high.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-cpu-high" src="/assets/images/edited-cpu-high-42e3f4260e84492d89c0e7308cafd16f.png" width="1129" height="213" class="img_ev3q"></a></p>
<p>테스트 후에 웹앱에 접근해보니 안되길래 container 내부의 로그를 확인해보니 아래 이미지처럼 SocketServer에서 오류가 발생해서 더 이상 서비스가 안된다. 오류 발생 이후에 접근이 안되는데도 200이 찍히는건 이해가 안되지만 일단 서비스가 죽을 정도의 부하를 발생시킬 수 있다는 걸 알았고 그걸 모니터링 할 수 있으니 성공.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/container-error.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="container-error" src="/assets/images/container-error-f3b57edfdcdf3d9eec0361228a738473.png" width="697" height="585" class="img_ev3q"></a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-load-balancing">5. Load balancing<a href="#5-load-balancing" class="hash-link" aria-label="Direct link to 5. Load balancing" title="Direct link to 5. Load balancing">​</a></h3>
<p>부하를 걸어서 서비스를 죽여는 봤으니 load balancing을 하면 어떻게 될지 궁금해졌다. 당연히 개선되겠지만 auto scaling을 구현했을 때 그 기능이 유효할지는 알아야 하니까. 부하는 동일하게, 테스트 대상인 웹앱의 instance를 2개  로 늘려서 다시 테스트. 이 때 ngrinder가 가리키는 url은 LB가 된다. (instance가 하나일때도 동일했음) LB가 request를 2개의 container에 적당히 알아서 분배해야할테니 죽더라도 어느 정도 개선된 지표가 확인되어야만 한다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-ngrinder-lb.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-ngrinder-lb" src="/assets/images/edited-ngrinder-lb-ad6b7a28f526cc3800c4c797142ad9f0.png" width="970" height="436" class="img_ev3q"></a></p>
<p>위 그림처럼 ngrinder에서 테스트 오류가 발생하지 않았고 TPS는 container가 하나일 때에는 최대 1400 정도였던 것이 1860까지 올라갔다. 이 때 부하를 받은 2개의 container와 VM의 cpu 사용량 상태는 아래와 같았다. (container는 각각 다른 VM에 올라가도록하고 해당 VM에는 테스트용 container, cAdvisor 이외에는 아무것도 없는 상태)</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2016/11/edited-cpu-lb.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="edited-cpu-lb" src="/assets/images/edited-cpu-lb-9509f2da8e09f012258cd5d618e43e77.png" width="1181" height="628" class="img_ev3q"></a></p>
<p>두개의 container 모두 할당된 core 이상의 점유율을 보이긴 했지만 서비스가 죽지는 않았고 그 상태에서 VM의 cpu 사용량은 50%를 넘지는 않았다. 추가로 LB가 올라가있는 VM의 점유율이 상당히 높아진 것도 확인.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-cadvisor의-장단점">6. cAdvisor의 장단점<a href="#6-cadvisor의-장단점" class="hash-link" aria-label="Direct link to 6. cAdvisor의 장단점" title="Direct link to 6. cAdvisor의 장단점">​</a></h3>
<p><strong>(1) 장점</strong></p>
<p>위에 링크된 비교 페이지에서처럼 cAdvisor는 구축이 무척 간단하다. 또 VM과 container의 상태 확 인이 가능하다는 것도 도움이 된다.</p>
<p><strong>(2) 단점</strong></p>
<p>특정 시점의 상태를 다시 확인할 수가 없고 정확한 결과값이 아니라 그래프로만 표시되어서 정확한 분석이 어렵다. REST API를 제공하는 것으로 봐서는 내부에서는 data를 쌓을 것 같기도 한데 UI로는 확인할 수가 없었다. REST API를 호출해야봐야 알겠지만 API로 제공하는 data도 그 순간의 data 뿐일수도 있다. 또, host와 container의 상태를 확인할 수는 있지만 한 화면에서 보는 것은 불가능해서 상당히 불편했는데 측정된 지표들이 시간에 따라 계속 흘러가기 때문에 동시에 확인하는 것이 힘들고 각 host에 설치되어야 하지만 클러스터링이 지원되지 않아 host 별로 따로 접속해서 확인해야 한다. Mesos, marathon과 엮어서 생각해봤을 때에는 mesos 내부에서 관리하는 container의 id와 marathon에서의 application 이름(예를 들면 simple-webapp 같은 사람이 인지할 수 있는 이름)이 매칭이 어려운데 cAdvisor에서 표시하는 container는 marathon에서의 application 이름이 아닌 것도 문제.</p>
<p> </p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-더-고민할-것들">7. 더 고민할 것들<a href="#7-더-고민할-것들" class="hash-link" aria-label="Direct link to 7. 더 고민할 것들" title="Direct link to 7. 더 고민할 것들">​</a></h3>
<p>Auto scaling을 위해서는 scaling 시점을 결정해야 하기 때문에 container와 VM의 상태에 대한 data를 얻을 수 있어야만 한다. 더 확인해봐야 하겠지만 cAdvisor의 data를 InfluxDB나 Redis 등에 전송한 후에 그 곳에서 쌓이는 data를 가지고 처리하는 방법도 있을 것 같고 아예 다른 모니터링 도구를 활용하는 방법도 생각해봐야겠다.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cadvisor">cadvisor</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/container">container</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker-monitoring">docker-monitoring</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker-performance-test">docker-performance-test</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker-stress-test">docker-stress-test</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker-모니터링">docker-모니터링</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker-부하-테스트">docker-부하-테스트</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/marathon">marathon</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/mesos">mesos</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/mesosphere">mesosphere</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ngrinder-사용">ngrinder-사용</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/메소스">메소스</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/컨테이너">컨테이너</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2016/11/28/wp/cadvisor-prometheus-grafana-for-docker-monitoring"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">cAdvisor + Prometheus + Grafana for Docker monitoring</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2016/11/05/wp/maas에-juju-bootstrap을-해보자"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MAAS에 juju bootstrap을 해보자</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-environments" class="table-of-contents__link toc-highlight">1. Environments</a></li><li><a href="#2-stress는-ngrinder로" class="table-of-contents__link toc-highlight">2. Stress는 ngrinder로</a></li><li><a href="#3-모니터링을-위해-cadvisor를-사용해보자" class="table-of-contents__link toc-highlight">3. 모니터링을 위해 cAdvisor를 사용해보자</a></li><li><a href="#4-container와-host에-걸리는-부하" class="table-of-contents__link toc-highlight">4. Container와 host에 걸리는 부하</a></li><li><a href="#5-load-balancing" class="table-of-contents__link toc-highlight">5. Load balancing</a></li><li><a href="#6-cadvisor의-장단점" class="table-of-contents__link toc-highlight">6. cAdvisor의 장단점</a></li><li><a href="#7-더-고민할-것들" class="table-of-contents__link toc-highlight">7. 더 고민할 것들</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>