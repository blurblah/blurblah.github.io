<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">ELK + Packetbeat로 요청을 지도에 표시하기 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blurblah.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blurblah.github.io/2018/04/23/wp/elk-packetbeat로-요청을-지도에-표시하기"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="ELK + Packetbeat로 요청을 지도에 표시하기 | My Site"><meta data-rh="true" name="description" content="서비스를 구성하면서 살펴보다 보면 어떤 서비스, 어떤 페이지에 request가 많은지 그 요청들은 어느 곳에서 많이 발생하는지 궁금할 때가 있다. 글로벌을 타겟으로 하는 서비스인 경우 특히 그럴 것이고 혹은 의도치 않은 곳에서 이상한 형태의 요청이 빈번할 경우 차단할지 판단하기 위해 필요할 수도 있다. Google Analytics 같은 서비스의 경우 이러한 요구사항을 간편한 방법으로 어느정도 해소할 수 있지만 어차피 여러가지 분석 용도로 ELK를 사용하고 있으니 packetbeat를 이용해보기로 했다."><meta data-rh="true" property="og:description" content="서비스를 구성하면서 살펴보다 보면 어떤 서비스, 어떤 페이지에 request가 많은지 그 요청들은 어느 곳에서 많이 발생하는지 궁금할 때가 있다. 글로벌을 타겟으로 하는 서비스인 경우 특히 그럴 것이고 혹은 의도치 않은 곳에서 이상한 형태의 요청이 빈번할 경우 차단할지 판단하기 위해 필요할 수도 있다. Google Analytics 같은 서비스의 경우 이러한 요구사항을 간편한 방법으로 어느정도 해소할 수 있지만 어차피 여러가지 분석 용도로 ELK를 사용하고 있으니 packetbeat를 이용해보기로 했다."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2018-04-23T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="ansible,ansible-playbook,ansible-role,elasticsearch,elk,geoip,geo_point,logstash,packetbeat,자동화-구성,지도"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blurblah.github.io/2018/04/23/wp/elk-packetbeat로-요청을-지도에-표시하기"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2018/04/23/wp/elk-packetbeat로-요청을-지도에-표시하기" hreflang="en"><link data-rh="true" rel="alternate" href="https://blurblah.github.io/2018/04/23/wp/elk-packetbeat로-요청을-지도에-표시하기" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.87564fa0.css">
<script src="/assets/js/runtime~main.e36f3c5d.js" defer="defer"></script>
<script src="/assets/js/main.dfb2dcc2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/blurblah" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2020/01/20/wp/kubernetes에서-특정-node에-pod가-배포되는-현상에-대한-분석">Kubernetes에서 특정 node에 pod가 배포되는 현상에 대한 분석</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/08/14/wp/kubernetes-with-aws-api-gateway">Kubernetes with AWS API gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/06/09/wp/날씨-정보를-편하게-받아볼까-해서-시작한-일들">날씨 정보를 편하게 받아볼까 해서 시작한 일들</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/27/wp/xiaomi-센서로-실내-온도를-측정해서-influxdb에-저장하고-grafana로-그">Xiaomi 센서로 실내 온도를 측정해서 InfluxDB에 저장하고 Grafana로 그린다</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2018/05/17/wp/snmp를-통한-asus-공유기-모니터링-시작하기">SNMP를 통한 ASUS 공유기  모니터링 시작하기</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="서비스를 구성하면서 살펴보다 보면 어떤 서비스, 어떤 페이지에 request가 많은지 그 요청들은 어느 곳에서 많이 발생하는지 궁금할 때가 있다. 글로벌을 타겟으로 하는 서비스인 경우 특히 그럴 것이고 혹은 의도치 않은 곳에서 이상한 형태의 요청이 빈번할 경우 차단할지 판단하기 위해 필요할 수도 있다. Google Analytics 같은 서비스의 경우 이러한 요구사항을 간편한 방법으로 어느정도 해소할 수 있지만 어차피 여러가지 분석 용도로 ELK를 사용하고 있으니 packetbeat를 이용해보기로 했다."><header><h1 class="title_f1Hy" itemprop="headline">ELK + Packetbeat로 요청을 지도에 표시하기</h1><div class="container_mt6G margin-vert--md"><time datetime="2018-04-23T00:00:00.000Z" itemprop="datePublished">April 23, 2018</time> · <!-- -->9 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>서비스를 구성하면서 살펴보다 보면 어떤 서비스, 어떤 페이지에 request가 많은지 그 요청들은 어느 곳에서 많이 발생하는지 궁금할 때가 있다. 글로벌을 타겟으로 하는 서비스인 경우 특히 그럴 것이고 혹은 의도치 않은 곳에서 이상한 형태의 요청이 빈번할 경우 차단할지 판단하기 위해 필요할 수도 있다. Google Analytics 같은 서비스의 경우 이러한 요구사항을 간편한 방법으로 어느정도 해소할 수 있지만 어차피 여러가지 분석 용도로 ELK를 사용하고 있으니 packetbeat를 이용해보기로 했다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="packetbeat">Packetbeat?<a href="#packetbeat" class="hash-link" aria-label="Direct link to Packetbeat?" title="Direct link to Packetbeat?">​</a></h3>
<p>ELK stack에서 로그 수집용으로 filebeat를 많이 사용하는데 filebeat는 특정 로그파일을 수집해서 logstash나 elasticsearch 등으로 전송하는 역할을 수행한다. Packetbeat는 로그파일 대신 network packet 데이터를 수집해서 전송할 수 있으며, 각종 프로토콜 별로 데이터를 분류해서 수집할 수 있게 되어있다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="테스트용-elk-구성">테스트용 ELK 구성<a href="#테스트용-elk-구성" class="hash-link" aria-label="Direct link to 테스트용 ELK 구성" title="Direct link to 테스트용 ELK 구성">​</a></h3>
<p>우선 packetbeat를 사용해서 어느 지역에서 요청이 들어오는지를 보고 싶은 게 1차 목표였는데 실제 운영중인 ELK를 건드리고 싶지는 않아서 새로운 VM에 Ansible로 다시 구성했다. 미리 만들어둔 5개의 role을 clone해서 아래와 비슷한 형태로 playbook을 만들고 실행하면 된다. ELK가 동시에 여러 종류의 beat에서 전달되는 데이터를 받아야하니 다른 문제가 있는지를 보기 위해 filebeat도 같이 구성했다.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-roles">1. Roles<a href="#1-roles" class="hash-link" aria-label="Direct link to 1. Roles" title="Direct link to 1. Roles">​</a></h4>
<p><a href="https://github.com/blurblah/ansible-role-elasticsearch" target="_blank" rel="noopener noreferrer">https://github.com/blurblah/ansible-role-elasticsearch</a></p>
<p><a href="https://github.com/blurblah/ansible-role-logstash" target="_blank" rel="noopener noreferrer">https://github.com/blurblah/ansible-role-logstash</a></p>
<p><a href="https://github.com/blurblah/ansible-role-kibana" target="_blank" rel="noopener noreferrer">https://github.com/blurblah/ansible-role-kibana</a></p>
<p><a href="https://github.com/blurblah/ansible-role-docker" target="_blank" rel="noopener noreferrer">https://github.com/blurblah/ansible-role-docker</a> (Dependency)</p>
<p><a href="https://github.com/blurblah/ansible-role-filebeat" target="_blank" rel="noopener noreferrer">https://github.com/blurblah/ansible-role-filebeat</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-playbook">2. Playbook<a href="#2-playbook" class="hash-link" aria-label="Direct link to 2. Playbook" title="Direct link to 2. Playbook">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- hosts: elk_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  become: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - role: elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: test-es</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - role: logstash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logstash_loglevel: debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - role: kibana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server_name: test-kibana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- hosts: elk_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  become: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - role: filebeat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logstash_host: &#x27;{{ ansible_default_ipv4.address }}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      logstash_port: 5044</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable_kibana_dashboard: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kibana_host: &#x27;{{ ansible_default_ipv4.address }}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kibana_port: 5601</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prospectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - { type: syslog, files: [&#x27;/var/log/auth.log&#x27;] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="packetbeat-구성">Packetbeat 구성<a href="#packetbeat-구성" class="hash-link" aria-label="Direct link to Packetbeat 구성" title="Direct link to Packetbeat 구성">​</a></h3>
<p>Packetbeat도 역시 Ansible role로 만들어서 ELK 구성과 비슷한 형태로 간단히 완료. Role은 <a href="https://github.com/blurblah/ansible-role-packetbeat" target="_blank" rel="noopener noreferrer">github</a>에서 가져오면 되고 요청을 분석하고 싶은 서버를 대상으로 아래와 같은 형태로 playbook을 만들어서 실행했다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- hosts: test_proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  become: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - role: packetbeat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      packetbeat_name: test_packetbeat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      packetbeat_protocols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - { type: tls, ports: [443] }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      packetbeat_loglevel: debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      out_logstash:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host: &#x27;{{ hostvars[&quot;elk_test&quot;].ansible_host }}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 5044</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>내가 분석하고자 했던 서버는 nginx로 되어있는 reverse proxy 였는데 인증서가 적용되어 있었기 때문에 type을 tls로 port는 443 하나만 넣어서 지정했다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="geoip-filter">Geoip filter<a href="#geoip-filter" class="hash-link" aria-label="Direct link to Geoip filter" title="Direct link to Geoip filter">​</a></h3>
<p>Packetbeat 까지 구성해서 데이터가 수집되는 것을 확인해보면 (Kibana에서 index pattern 생성까지 한 경우) 요청 ip, url, protocol 등은 표시되지만 위치 정보에 대한 내용은 없다. Logstash의 geoip filter는 수집된 정보 중 ip와 내부 DB에 매핑된 정보를 가지고 geoip라는 field를 생성해주는 역할을 수행한다고 해서 아래처럼 logstash pipeline 경로에 filter를 설정해주었다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [@metadata][beat] == &quot;packetbeat&quot; and [client_ip] and [client_ip] !~ /^10\./ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    geoip {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source =&gt; &quot;client_ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Filebeat 등 다른 beat들은 geoip filter를 적용하지 않을 것이기 때문에 metadata를 이용해 거르게 했다. Private ip의 경우 위치 정보에 대해서 매핑된 정보가 없기 (알 수도 없고) 때문에 내 환경에서 요청이 발생하는 10.0.0.0/16 대역에 대해서도 적용하지 않기로 했다. Private ip에 대해서 처리를 하게 되면 아래와 같은 오류가 발생한다.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[2018-04-18T04:52:51,124][DEBUG][logstash.filters.geoip   ] IP 10.x.x.x was not found in the database {:event=&gt;#&lt;LogStash::Event:0x65726e3c&gt;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Filter 설정은 좀 더 살펴보고 더 효율적으로 수정할 필요는 있을 것 같다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="geoip-field-인식-문제">Geoip field 인식 문제<a href="#geoip-field-인식-문제" class="hash-link" aria-label="Direct link to Geoip field 인식 문제" title="Direct link to Geoip field 인식 문제">​</a></h3>
<p>Filter 설정 후 logstash를 restart 하고 나서 kibana 쪽에서 살펴보니 없던 geoip field 들이 새로 만들어지는건 확인이 되는데 아래 그림처럼 warning이 발생하는 걸 볼 수 있었다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-geoip-warning.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-geoip-warning-24318b8bb9e059e53fa4d3f18973237b.png" width="770" height="364" class="img_ev3q"></a></p>
<p>이전에 데이터 들어오는걸 보겠다고 index pattern을 생성했는데 그 시점의 index에는 없던 field 들이기 때문에 warning이 발생하는 것이라서 index pattern을 제거하고 다시 생성해주는 걸로 문제를 해결</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="geo_point-type">geo_point type<a href="#geo_point-type" class="hash-link" aria-label="Direct link to geo_point type" title="Direct link to geo_point type">​</a></h3>
<p>Warning이 없어졌으니 kibana의 visualize 메뉴에 가서 map을 추가해 그려볼까 하고 설정을 해보니 아래와 같은 오류가 뜨면서 그려지질 않는다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-map-invalid-fieldtype.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-map-invalid-fieldtype-c06ac3205d9500520b4293b900f39697.png" width="326" height="528" class="img_ev3q"></a></p>
<p>무엇이 문제인가 싶어서 index pattern에서 field들의 type을 살펴보니 geo_point type으로 된 field가 보이질 않는다. 이런 부분은 좀 개선이 필요해 보이는데 field 들이 filter에 의해 자동으로 생성되는 것이라 알아서 처리되면 편할 것 같다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-fields.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-fields-efaae611930a20ccdcf7c05da13994db.png" width="640" height="689" class="img_ev3q"></a></p>
<p>이런 경우 elasticsearch에서 생성하는 index에 대한 변경이 필요한데 이미 존재하는 index를 일괄 변경하는 방법도 있을 것 같고 새로 생성되는 index에 대해서 적용할 template을 추가하는 방법도 있을 수 있다. 나의 경우엔 이미 만들어진 index와 데이터가 거의 없는 상태이기 때문에 존재하는 index는 모두 제거하고 template을 추가해서 이후 생성되는 index에 대해서만 field type이 변경되도록 했다. Template을 적용하기 위해서는 아래와 같은 json 파일을 생성해서 elasticsearch에 밀어넣어야 한다. (이전에 index, index pattern 제거하고 진행함)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;template&quot;: &quot;packetbeat-*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mappings&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_default_&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;geoip&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;location&quot;: {&quot;type&quot;: &quot;geo_point&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Json 생성 후 elasticsearch에게 보내주자.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -XPUT -H &quot;Content-Type: application/json&quot; localhost:9200/_template/packetbeat_geoip -d@packetbeat_geoip.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>다시 packetbeat 로부터 데이터가 들어오기 시작하면 template이 적용된 index가 생성되고 kibana에서 index pattern을 다시 생성해 확인해보면 아래처럼 geoip.location field가 geo_point type으로 되어있는 것을 확인할 수 있다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-geopoint.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-geopoint-e0f248a9c375a864a97f41744eec282e.png" width="443" height="98" class="img_ev3q"></a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="이제-지도를-그리자">이제 지도를 그리자<a href="#이제-지도를-그리자" class="hash-link" aria-label="Direct link to 이제 지도를 그리자" title="Direct link to 이제 지도를 그리자">​</a></h3>
<p>오류가 발생하던 부분을 해결했으니 다시 visualize 메뉴에서 지도를 추가해 설정하면 아래처럼 요청 횟수에 따라 색깔별로 표시되는 걸 볼 수 있다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-map-kor.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-map-kor-1024x569-2daa08cc258f144a17ca337e7850eaf1.png" width="1024" height="569" class="img_ev3q"></a></p>
<p>VPN에 연결해서 다른 나라로부터의 요청도 제대로 표시되는지 확인해보니 별 문제없이 된다.</p>
<p><a href="http://13.125.231.217/wp-content/uploads/2018/04/packetbeat-map-us.png" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="/assets/images/packetbeat-map-us-1024x566-224c853de258fa31f047157e4aa68fb1.png" width="1024" height="566" class="img_ev3q"></a></p>
<p> </p>
<p>Packetbeat로부터 들어오는 데이터들을 간단히 살펴보니 사실 지역에 대한 정보 이외에도 쓸만한 내용들이 많다. 요청 url 별로 분석할 때도 유용할 것 같고 protocol type (service) 별로 구분해서 확인하는 것도 쉽게 가능할 것 같다. 그러나 이런 도구들로 분석할만한 서비스를 만들어내는 건 어려운 문제 :)</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ansible">ansible</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ansible-playbook">ansible-playbook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ansible-role">ansible-role</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/elasticsearch">elasticsearch</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/elk">elk</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/geoip">geoip</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/geo-point">geo_point</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/logstash">logstash</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/packetbeat">packetbeat</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/자동화-구성">자동화-구성</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/지도">지도</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2018/05/08/wp/elk에서-docker-log-수집하기"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">ELK에서 Docker log 수집하기</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2018/03/29/wp/dynamic-routing을-위한-zuul과-spring-cloud-config"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Dynamic routing을 위한 Zuul과 Spring cloud config</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#packetbeat" class="table-of-contents__link toc-highlight">Packetbeat?</a></li><li><a href="#테스트용-elk-구성" class="table-of-contents__link toc-highlight">테스트용 ELK 구성</a></li><li><a href="#packetbeat-구성" class="table-of-contents__link toc-highlight">Packetbeat 구성</a></li><li><a href="#geoip-filter" class="table-of-contents__link toc-highlight">Geoip filter</a></li><li><a href="#geoip-field- 인식-문제" class="table-of-contents__link toc-highlight">Geoip field 인식 문제</a></li><li><a href="#geo_point-type" class="table-of-contents__link toc-highlight">geo_point type</a></li><li><a href="#이제-지도를-그리자" class="table-of-contents__link toc-highlight">이제 지도를 그리자</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>